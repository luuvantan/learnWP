if (self.CavalryLogger) { CavalryLogger.start_js(["3B\/s\/"]); }

__d("CurationCaretNux",["csx","cx","Arbiter","AsyncRequest","CSS","DataStore","DOM","Event","NavigationMessage","Parent","Rect","ge","tidyEvent"],(function(a,b,c,d,e,f,g,h){__p&&__p();var i="div._1zpr",j="div._6ks",k="._3x-2 img.img",l="span.text_exposed_link",m="_5jmm",n="CurationCaretNux_instance",o="CurationCaretNux_caretMenuLoaded",p=100,q="LINK_WELCOME",r="VIDEO_WELCOME",s="POST_SAVE_WELCOME",t="PHOTO_WELCOME",u="caret_nux",v="save_option_nux",w="seen",x="dismissed",y="focus",z="click",A="scroll",B=!1,C=null,D=null;a=function(){"use strict";__p&&__p();function a(a,c,d,e,f,g){__p&&__p();e=b("ge")(e);if(e){this.container=e;this.caret=d;this.caretNux=a.instance;this.caretNuxData=a;this.saveOptionNux=c.instance;this.saveOptionNuxData=c;this.allowAutoplayNux=g;this.popoverTriggered=!1;d=b("Parent").byClass(e,m);b("DataStore").set(d,n,this);switch(f){case q:this.$1();break;case r:this.$1();this.$2();this.$3();break;case s:this.$4();break;case t:this.$5();break}b("Arbiter").subscribeOnce(b("NavigationMessage").NAVIGATION_BEGIN,function(){this.caretNux&&this.caretNux.hide(),this.saveOptionNux&&this.saveOptionNux.hide()}.bind(this))}}var c=a.prototype;c.$1=function(){__p&&__p();var a=b("DOM").scry(this.container,i);a.length>0&&b("tidyEvent")([b("Event").listen(a[0],"click",function(){__p&&__p();if(B||this.videoPlaying)return;this.caretNux.subscribe("show",function(){this.$6()}.bind(this));this.caretNux.subscribe("hide",function(){this.$7(),B&&(this.$8(u,w),this.$8(u,x))}.bind(this));this.$9();this.interactionTime=0;window.setTimeout(function(){this.$10()||(B=!0,this.caretNux.show())}.bind(this),this.caretNuxData.min_consume_duration);window.setTimeout(function(){this.$10()||(B=!1,this.caretNux.hide())}.bind(this),this.caretNuxData.max_consume_duration);var a=Date.now();window.setTimeout(function(){this.$11(function(){this.interactionTime||(this.interactionTime=Date.now()-a)}.bind(this))}.bind(this),0)}.bind(this))])};c.$2=function(){var a=b("DOM").scry(this.container,j);a.length>0&&b("tidyEvent")([b("Event").listen(a[0],"click",function(){this.videoPlaying=!0}.bind(this))])};c.$3=function(){if(!this.allowAutoplayNux)return;D===null&&(D=this.caretNuxData.min_consume_duration);C===null&&!B&&(C=b("Arbiter").subscribe("flash/updateStatus",function(a,c){if(!B&&D!==null&&c.position*1e3>D){a=b("Parent").byClass(b("ge")(c.divID),m);c=b("DataStore").get(a,n);c&&(B=!0,c.caretNux.show(),c.$6(),b("Arbiter").unsubscribe(C))}}))};c.$4=function(){var a=b("DOM").scry(this.container,l);a.length>0&&b("tidyEvent")([b("Event").listen(a[0],"click",function(){if(B)return;B=!0;this.caretNux.show();this.$6()}.bind(this))])};c.$5=function(){__p&&__p();var a=b("DOM").scry(this.container,k);a.forEach(function(a){__p&&__p();a=b("Parent").byTag(a,"a");if(!a)return;b("Event").listen(a,"click",function(){if(B)return;var a=b("Arbiter").subscribe("PhotoSnowlift.OPEN",function(){var c=Date.now(),d=b("Arbiter").subscribe("PhotoSnowlift.CLOSE",function(){var a=Date.now()-c;a>this.caretNuxData.min_consume_duration&&a<this.caretNuxData.max_consume_duration&&(B=!0,this.caretNux.show(),this.$6());b("Arbiter").unsubscribe(d)}.bind(this));b("Arbiter").unsubscribe(a)}.bind(this))}.bind(this))},this)};c.$10=function(){return this.interactionTime&&this.interactionTime>0};c.$6=function(){__p&&__p();this.caretClickListener=b("Event").listen(this.caret,"click",function(){this.caretNux.hide(),this.saveOptionNux&&(this.popoverTriggered=!0,this.$12())}.bind(this));var a=!1,c=function(c){if(a||c===z||!this.caretNux.isShown())return;c=b("Rect").getViewportWithoutScrollbarsBounds();var d=b("Rect").getElementBounds(this.caretNux.getContentRoot());d=d.sub(0,p);c.contains(d)&&(this.$8(u,w),a=!0)}.bind(this);c();this.$9();this.$11(c)};c.$7=function(){this.caretClickListener.remove(),this.$13()};c.$12=function(){__p&&__p();this.$14()&&this.popoverTriggered&&window.setTimeout(function(){__p&&__p();var a=b("DOM").scry(document,"li.save_caret_menu_item");for(var c=0;c<a.length;c++){var d=a[c],e=b("Parent").byClass(d,"uiLayer");if(e&&b("CSS").shown(e)){this.saveOptionNux.setContext(d);break}}this.saveOptionNux.show();this.$8(v,w);e=b("DataStore").get(this.caret,"Popover");e&&e.subscribeOnce("hide",function(){this.saveOptionNux.hide()}.bind(this))}.bind(this),0)};c.$8=function(a,c){__p&&__p();var d;if(a===u)d=this.caretNuxData;else if(a===v)d=this.saveOptionNuxData;else throw new Error("Invalid nux type");var e;if(c===w)e=d.seen_uri,d.seen_uri=null;else if(c===x)e=d.dismiss_uri,d.dismiss_uri=null;else throw new Error("Invalid impression type");if(e){c=new(b("AsyncRequest"))(e);this.interactionTime&&a===u&&c.setData({interaction_time:this.interactionTime});c.send()}};c.$11=function(a){this.$15.push(a)};c.$16=function(a){this.$15.forEach(function(b){b.call(this,a)},this)};c.$9=function(){this.$17||(this.$15=[],this.$17=[b("Event").listen(window,"click",this.$16.bind(this,z)),b("Event").listen(window,"focus",this.$16.bind(this,y)),b("Event").listen(window,"scroll",this.$16.bind(this,A))])};c.$13=function(a){if(this.$17){while(this.$17.length)this.$17.pop().remove();this.$17=null;this.$15=null}};c.$14=function(){var a=b("Parent").byClass(this.container,m);return b("DataStore").get(a,o)===!0};a.saveOptionLoaded=function(a){a=b("ge")(a);if(a){a=b("Parent").byClass(a,m);if(a){b("DataStore").set(a,o,!0);a=b("DataStore").get(a,n);a&&a.$12()}}};return a}();e.exports=a}),null);
__d("ContextualLayerInlineTabOrder",["DOM","DOMTraverser","Event","Focus","Keys","SubscriptionsHandler","TabbableElements","getOrCreateDOMID"],(function(a,b,c,d,e,f){__p&&__p();a=function(){"use strict";__p&&__p();function a(a){this._layer=a,this._isSetup=!1,this._ignoreFocus=!1,this._layerFocused=!0,this._layerRoot=this._layer.getContentRoot(),this._layerID=b("getOrCreateDOMID")(this._layerRoot),this._mutedTabbables=new Map([]),this._subscriptions=new(b("SubscriptionsHandler"))(),this._tabbableLayerElements=[]}var c=a.prototype;c.enable=function(){this._subscriptions.addSubscriptions(this._layer.subscribe("aftershow",this._onAfterShow.bind(this)),this._layer.subscribe("hide",this._onAfterHide.bind(this))),this._layer.isShown()&&this._onAfterShow()};c.disable=function(){this._subscriptions.release(),this._isSetup=!1};c._getContext=function(){return this._layer.getCausalElement()};c._getContextOwns=function(){var a=this._getContext();if(!a)return[];a=(a.getAttribute("aria-owns")||"").trim();a=a?a.match(/[^ ]+/g):[];return a};c._identifyTabbableElements=function(){this._tabbableLayerElements=b("TabbableElements").find(this._layerRoot),!this._tabbableLayerElements.length&&!this._mutedTabbables.size&&this._layerRoot.setAttribute("tabindex","0"),this._layerRoot.tabIndex>=0&&this._tabbableLayerElements.unshift(this._layerRoot)};c._onAfterShow=function(){this._setupTabBehavior();var a=this._getContext(),b=this._getContextOwns();a&&!b.includes(this._layerID)&&(b.push(this._layerID),a.setAttribute("aria-owns",b.join(" ")))};c._onAfterHide=function(){var a=this._getContext();if(a){var b=this._getContextOwns(),c=b.indexOf(this._layerID);c>-1&&(b.splice(c,1),a.setAttribute("aria-owns",b.join(" ")))}};c._setupTabBehavior=function(){if(!this._isSetup){var a=this._getContext();if(!this._layerRoot||!a)return;this._setupTabTriggers();this._setupTabToggle();this._isSetup=!0}};c._setupTabTriggers=function(){var a=this._getContext();b("TabbableElements").isTabbable(a)||a.setAttribute("tabindex","0");this._subscriptions.addSubscriptions(b("Event").listen(a,"keyup",this._checkNUXFocus.bind(this)),b("Event").listen(a,"keydown",this._checkNUXFocus.bind(this)),b("Event").listen(this._layerRoot,"keydown",this._checkContextFocus.bind(this)),b("Event").listen(this._layerRoot,"layerFocus",this._setNUXFocusStart.bind(this)),b("Event").listen(this._layerRoot,"layerFocusEnd",this._setNUXFocusEnd.bind(this)),b("Event").listen(this._layerRoot,"tempFocusIgnore",this._tempIgnoreFocus.bind(this)))};c._setupTabToggle=function(){this._handleLayerBlur(),this._subscriptions.addSubscriptions(b("Event").listen(document.documentElement,"click",this._checkForFocus.bind(this)),b("Event").listen(document.documentElement,"keydown",this._checkForFocus.bind(this)))};c._handleLayerBlur=function(){__p&&__p();if(!this._layerFocused)return;this._identifyTabbableElements();this._tabbableLayerElements.forEach(function(a){if(!this._mutedTabbables.has(a)){var b=a.getAttribute("tabindex");a.setAttribute("tabindex","-1");this._mutedTabbables.set(a,b)}},this);this._layerFocused=!1};c._handleLayerFocus=function(){__p&&__p();if(this._layerFocused)return;for(var a=this._mutedTabbables,b=Array.isArray(a),c=0,a=b?a:a[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var d;if(b){if(c>=a.length)break;d=a[c++]}else{c=a.next();if(c.done)break;d=c.value}d=d;var e=d[0];d=d[1];d===null?e.removeAttribute("tabindex"):e.setAttribute("tabindex",d)}this._mutedTabbables.clear();this._layerFocused=!0};c._checkNUXFocus=function(a){__p&&__p();if(this._ignoreFocus){a.preventDefault();this._ignoreFocus=!1;return}if(a.getTarget()!==this._getContext()||!this._layer.isShown())return;var c=b("Event").getKeyCode(a),d=this._getContextOwns();if(!d.length||c!==b("Keys").TAB)return;c=a.getModifiers();c=c.shift;var e=d[0]===this._layerID;d=d[d.length-1]===this._layerID;(a.type==="keydown"&&c&&d||a.type==="keyup"&&!c&&e)&&(a.preventDefault(),b("Event").fire(this._layerRoot,c?"layerFocusEnd":"layerFocus"))};c._setNUXFocusStart=function(){this._handleLayerFocus(),this._identifyTabbableElements(),b("Focus").set(this._tabbableLayerElements[0])};c._setNUXFocusEnd=function(){this._handleLayerFocus(),this._identifyTabbableElements(),b("Focus").set(this._tabbableLayerElements[this._tabbableLayerElements.length-1])};c._tempIgnoreFocus=function(){this._ignoreFocus=!0};c._checkContextFocus=function(a){var c=b("Event").getKeyCode(a),d=a.getModifiers();d=d.shift;this._handleLayerFocus();this._identifyTabbableElements();if(!this._tabbableLayerElements.length||c!==b("Keys").TAB||!this._getContext())return;c=this._tabbableLayerElements[0];var e=this._tabbableLayerElements[this._tabbableLayerElements.length-1];a.getTarget()===e&&!d?this._setFocusAfterLayer()&&a.preventDefault():a.getTarget()===c&&d&&(this._setFocusBeforeLayer()&&a.preventDefault())};c._isTabbableNode=function(a){return b("TabbableElements").isTabbable(a)&&!b("DOM").contains(this._layerRoot,a)};c._setFocusBeforeLayer=function(){__p&&__p();var a=this._getContextOwns();if(!a||!a.length)return!1;if(a[0]===this._layerID){var c=b("DOMTraverser").previousFilteredNode(document.body,this._getContext(),this._isTabbableNode.bind(this));b("Focus").set(c);return!0}if(a.includes(this._layerID)){c=a[a.indexOf(this._layerID)-1];return this._focusOnElement(c,!0)}return!1};c._setFocusAfterLayer=function(){__p&&__p();var a=this._getContextOwns();if(!a||!a.length)return!1;if(a[a.length-1]===this._layerID){this._refocusOnContext();return!0}if(a.includes(this._layerID)){a=a[a.indexOf(this._layerID)+1];return this._focusOnElement(a,!1)}return!1};c._focusOnElement=function(a,c){a=document.getElementById(a);if(!a)return!1;b("Event").fire(a,c?"layerFocusEnd":"layerFocus");this._handleLayerBlur();return!0};c._refocusOnContext=function(a){a=this._getContext();var c=this._getContextOwns();b("Event").fire(document.getElementById(c[0]),"tempFocusIgnore");this._handleLayerBlur();a&&(a.tabIndex==null?(a.tabIndex=-1,b("Focus").setWithoutOutline(a)):b("Focus").set(a))};c._checkForFocus=function(a){a=a.getTarget();var c=this._layer.getContentRoot();c=b("DOM").contains(c,a);!this._ignoreFocus&&!this._layerFocused&&c&&this._handleLayerFocus();this._layerFocused&&!c&&this._handleLayerBlur()};return a}();e.exports=a}),null);